name: Claude Code Site Editor

on:
  # Trigger on new issues
  issues:
    types: [opened]

  # Trigger on issue and PR comments mentioning @claude
  issue_comment:
    types: [created]

jobs:
  claude:
    # Only run on [Site Edit] issues or @claude comments
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.title, '[Site Edit]')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Use pre-built container with Playwright (saves ~2 min per run)
    # First run: image builds via build-runner-image.yml workflow
    container:
      image: ghcr.io/dgrtwo/all-upfront-runner:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      packages: read  # Required to pull container image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: ""  # Respond to all issues, not just @claude mentions
          show_full_output: true
          claude_args: "--model claude-sonnet-4-5-20250929 --allowedTools 'Bash(git:*),Bash(npm:*),Bash(npx:*),Bash(pkill:*),Bash(sleep:*),Bash(grep:*),Bash(cat:*),Bash(sed:*),Bash(gh:*),Bash(curl:*),Edit,Write,Read'"
          prompt: |
            Edit the Upfront marketing site. Read CLAUDE.md for structure and rules.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            If this is a comment with approval ("ship it", "lgtm", "approved", etc.), merge the PR with `gh pr merge --squash`.
