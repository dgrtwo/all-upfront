name: Claude Code Site Editor

on:
  # Trigger on new issues
  issues:
    types: [opened]

  # Trigger on issue and PR comments mentioning @claude
  issue_comment:
    types: [created]

jobs:
  claude:
    # Only run on issues/comments that might be relevant
    # - New issues (always process)
    # - Comments that mention @claude
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Use pre-built container with Playwright (saves ~2 min per run)
    # First run: image builds via build-runner-image.yml workflow
    container:
      image: ghcr.io/dgrtwo/all-upfront-runner:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      packages: read  # Required to pull container image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: ""  # Respond to all issues, not just @claude mentions
          show_full_output: true
          claude_args: "--model claude-opus-4-6 --allowedTools 'Bash(git:*),Bash(npm:*),Bash(npx:*),Bash(pkill:*),Bash(sleep:*),Bash(grep:*),Bash(cat:*),Bash(sed:*),Bash(gh:*),Edit,Write,Read'"
          prompt: |
            You are helping a non-technical founder make edits to their marketing website.

            CURRENT TASK:
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            ---

            IMPORTANT RULES:
            1. Read the CLAUDE.md file first to understand the project structure, constraints, and TESTING REQUIREMENTS.
            2. Implement the requested changes.
            3. BEFORE opening a PR, you MUST test your changes:
               - Run "npm run build" to verify the site builds
               - Start preview server: "npm run preview &" then "sleep 3"
               - Screenshot the modified page with Playwright: "npx playwright screenshot http://localhost:4321/PAGE_PATH screenshot.png"
               - Verify the screenshot shows your changes correctly
               - Kill the server: "pkill -f 'astro preview' || true"
            4. Create a new branch and open a PR linking back to the issue.
            5. Write PR descriptions in plain language - no technical jargon.
            6. Mention that Cloudflare will post a preview link for final review.

            APPROVAL AND MERGING:
            If this is a comment and the commenter has used approval language like:
            - "ship it"
            - "looks good"
            - "approved"
            - "lgtm"
            - "merge this"
            - "go ahead"
            - "good to go"
            - "perfect"
            - "great"
            - "merge it"
            - "let's ship"

            Then you should:
            1. Merge the PR using: gh pr merge --squash
            2. Comment confirming the merge: "Merged! Your changes will be live at allupfront.com in a few minutes."

            If the comment is NOT an approval (e.g., asking questions or requesting changes), respond helpfully and make any requested changes.

            NEVER merge based on your own judgment - only merge when you detect explicit approval language from the user.
